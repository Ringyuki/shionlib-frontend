name: deploy frontend

on:
  push:
    branches: [main]

concurrency:
  group: shionlib-frontend-deploy
  cancel-in-progress: true

jobs:
  checks:
    name: Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Format check
        run: pnpm format:check

      - name: ESLint
        run: pnpm lint

      - name: Type check
        run: pnpm exec tsc -p tsconfig.json --noEmit

  build-and-deploy:
    name: Build and Deploy
    needs: checks
    environment: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          NEXT_PUBLIC_PROD_API_PATH: ${{ vars.NEXT_PUBLIC_PROD_API_PATH }}
          NEXT_PUBLIC_API_PORT: ${{ vars.NEXT_PUBLIC_API_PORT }}
          NEXT_PUBLIC_SHIONLIB_IMAGE_BED_HOST: ${{ vars.NEXT_PUBLIC_SHIONLIB_IMAGE_BED_HOST }}
          NEXT_PUBLIC_SHIONLIB_IMAGE_BED_URL: ${{ vars.NEXT_PUBLIC_SHIONLIB_IMAGE_BED_URL }}
        run: pnpm build

      - name: Compose standalone bundle
        run: |
          cp -r public .next/standalone/
          mkdir -p .next/standalone/.next
          cp -r .next/static .next/standalone/.next/

      - name: Archive artifact
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          TAR_NAME="release-${SHORT_SHA}.tgz"
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          tar -czf "$TAR_NAME" -C .next/standalone .

      - name: Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: '${{ env.TAR_NAME }}'
          target: '/tmp'

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        env:
          GITHUB_SHA: ${{ github.sha }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: 'GITHUB_SHA,DEPLOY_DIR'
          script: |
            set -euo pipefail
            DEPLOY_DIR="${{ secrets.DEPLOY_DIR }}"
            KEEP_RELEASES=5

            mkdir -p "$DEPLOY_DIR/releases" "$DEPLOY_DIR/current"

            SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
            TS_UTC=$(date -u +%Y%m%d%H%M%S)
            RELEASE_NAME="${TS_UTC}-${SHORT_SHA}"
            RELEASE_DIR="$DEPLOY_DIR/releases/$RELEASE_NAME"
            SHARED_DIR="$DEPLOY_DIR/shared"

            TAR_NAME="release-${SHORT_SHA}.tgz"
            mkdir -p "$RELEASE_DIR"
            tar -xzf "/tmp/$TAR_NAME" -C "$RELEASE_DIR"
            rm -f "/tmp/$TAR_NAME"

            ln -sfn "$SHARED_DIR/.env" "$RELEASE_DIR/.env"
            ln -sfn "$SHARED_DIR/ecosystem.config.cjs" "$RELEASE_DIR/ecosystem.config.cjs"
            ln -sfn "$RELEASE_DIR" "$DEPLOY_DIR/current"

            cd "$DEPLOY_DIR/current"
            set -x
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
              nvm use --silent >/dev/null 2>&1 || true
            fi
            export PATH="$PATH:/usr/local/bin:$HOME/.local/bin:$HOME/.npm-global/bin"
            if command -v npm >/dev/null 2>&1; then
              export PATH="$(npm bin -g):$PATH"
            fi
            echo "whoami=$(whoami)"
            echo "PATH=$PATH"
            command -v node || true
            node -v || true
            command -v pm2 || true
            pm2 -v || true

            PM2_BIN="$(command -v pm2 || true)"
            if [ -z "$PM2_BIN" ]; then
              for candidate in "$HOME/.nvm/versions/node"/*/bin/pm2 \
                               "/usr/local/bin/pm2" \
                               "/usr/bin/pm2"; do
                if [ -x "$candidate" ]; then
                  PM2_BIN="$candidate"
                  break
                fi
              done
            fi
            if [ -z "$PM2_BIN" ]; then
              echo "pm2 not found in PATH or common locations" >&2
              exit 127
            fi

            "$PM2_BIN" restart shionlib-frontend || "$PM2_BIN" start "ecosystem.config.cjs" --env production

            cd "$DEPLOY_DIR/releases"
            ls -1dt */ | tail -n +$((KEEP_RELEASES+1)) | xargs -r rm -rf
