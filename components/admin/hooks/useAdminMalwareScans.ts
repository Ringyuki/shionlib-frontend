'use client'

import { useCallback, useEffect, useState } from 'react'
import { shionlibRequest } from '@/utils/request'
import { PaginatedResponse } from '@/interfaces/api/shionlib-api-res.interface'
import {
  AdminMalwareScanCaseDetail,
  AdminMalwareScanCaseItem,
  AdminMalwareScanCaseListQuery,
  AdminMalwareScanDecision,
} from '@/interfaces/admin/malware-scan.interface'

export function useAdminMalwareScanCaseList(query: AdminMalwareScanCaseListQuery = {}) {
  const [data, setData] = useState<PaginatedResponse<AdminMalwareScanCaseItem> | null>(null)
  const [isLoading, setIsLoading] = useState(true)

  const fetchData = useCallback(async () => {
    setIsLoading(true)
    try {
      const params = new URLSearchParams()
      if (query.page) params.set('page', query.page.toString())
      if (query.limit) params.set('pageSize', query.limit.toString())
      if (query.status) params.set('status', query.status)
      if (query.decision_source) params.set('decision_source', query.decision_source)
      if (query.file_id !== undefined) params.set('file_id', query.file_id.toString())
      if (query.resource_id !== undefined) params.set('resource_id', query.resource_id.toString())
      if (query.uploader_id !== undefined) params.set('uploader_id', query.uploader_id.toString())
      if (query.reviewer_id !== undefined) params.set('reviewer_id', query.reviewer_id.toString())
      if (query.sortBy) params.set('sortBy', query.sortBy)
      if (query.sortOrder) params.set('sortOrder', query.sortOrder)

      const queryString = params.toString()
      const url = `/admin/content/malware-scan-cases${queryString ? `?${queryString}` : ''}`
      const res = await shionlibRequest().get<PaginatedResponse<AdminMalwareScanCaseItem>>(url)
      setData(res.data)
    } catch (error) {
      console.error('Failed to fetch malware scan case list:', error)
      setData(null)
    } finally {
      setIsLoading(false)
    }
  }, [
    query.page,
    query.limit,
    query.status,
    query.decision_source,
    query.file_id,
    query.resource_id,
    query.uploader_id,
    query.reviewer_id,
    query.sortBy,
    query.sortOrder,
  ])

  useEffect(() => {
    fetchData()
  }, [fetchData])

  return { data, isLoading, refetch: fetchData }
}

export async function getAdminMalwareScanCaseDetail(
  id: number,
): Promise<AdminMalwareScanCaseDetail> {
  const res = await shionlibRequest().get<AdminMalwareScanCaseDetail>(
    `/admin/content/malware-scan-cases/${id}`,
  )
  return res.data as AdminMalwareScanCaseDetail
}

export async function reviewAdminMalwareScanCase(
  id: number,
  data: {
    decision: AdminMalwareScanDecision
    review_note?: string
    notify_uploader?: boolean
  },
) {
  const res = await shionlibRequest().patch<AdminMalwareScanCaseDetail>(
    `/admin/content/malware-scan-cases/${id}/review`,
    { data },
  )
  return res.data as AdminMalwareScanCaseDetail
}
