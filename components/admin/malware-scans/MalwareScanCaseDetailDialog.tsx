'use client'

import { useEffect, useMemo, useState } from 'react'
import { useLocale, useTranslations } from 'next-intl'
import { toast } from 'react-hot-toast'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/shionui/Dialog'
import { Badge } from '@/components/shionui/Badge'
import { Skeleton } from '@/components/shionui/Skeleton'
import { Separator } from '@/components/shionui/Separator'
import { Textarea } from '@/components/shionui/Textarea'
import { Label } from '@/components/shionui/Label'
import { Checkbox } from '@/components/shionui/Checkbox'
import { Button } from '@/components/shionui/Button'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/shionui/Select'
import {
  AdminMalwareScanDecision,
  AdminMalwareScanCaseDetail,
} from '@/interfaces/admin/malware-scan.interface'
import {
  getAdminMalwareScanCaseDetail,
  reviewAdminMalwareScanCase,
} from '@/components/admin/hooks/useAdminMalwareScans'
import { formatBytes } from '@/utils/format'

interface MalwareScanCaseDetailDialogProps {
  caseId: number | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onReviewed?: () => void
}

const formatDate = (value: string | null | undefined, locale: string) => {
  if (!value) return '-'
  const date = new Date(value)
  if (Number.isNaN(date.getTime())) return '-'
  return date.toLocaleString(locale)
}

const getGameTitle = (detail: AdminMalwareScanCaseDetail | null) => {
  if (!detail?.resource?.game) return null
  return (
    detail.resource.game.title_zh ||
    detail.resource.game.title_en ||
    detail.resource.game.title_jp ||
    null
  )
}

export function MalwareScanCaseDetailDialog({
  caseId,
  open,
  onOpenChange,
  onReviewed,
}: MalwareScanCaseDetailDialogProps) {
  const t = useTranslations('Admin.MalwareScans')
  const locale = useLocale()
  const [detail, setDetail] = useState<AdminMalwareScanCaseDetail | null>(null)
  const [loading, setLoading] = useState(false)
  const [isBusy, setIsBusy] = useState(false)
  const [decision, setDecision] = useState<AdminMalwareScanDecision>('ALLOW')
  const [reviewNote, setReviewNote] = useState('')
  const [notifyUploader, setNotifyUploader] = useState(true)

  const loadDetail = async (id: number) => {
    setLoading(true)
    try {
      const data = await getAdminMalwareScanCaseDetail(id)
      setDetail(data)
      setReviewNote(data.review_note ?? '')
    } catch {
      setDetail(null)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    if (!open || !caseId) return
    setDecision('ALLOW')
    setNotifyUploader(true)
    setReviewNote('')
    loadDetail(caseId)
  }, [open, caseId])

  const statusVariant = useMemo(() => {
    if (!detail) return 'neutral' as const
    if (detail.status === 'PENDING') return 'warning' as const
    if (detail.status === 'RELEASED_FALSE_POSITIVE') return 'info' as const
    return 'destructive' as const
  }, [detail])

  const handleReview = async () => {
    if (!detail || detail.status !== 'PENDING') return

    setIsBusy(true)
    try {
      const reviewed = await reviewAdminMalwareScanCase(detail.id, {
        decision,
        review_note: reviewNote.trim() || undefined,
        notify_uploader: notifyUploader,
      })
      setDetail(reviewed)
      toast.success(t('reviewSaved'))
      onReviewed?.()
      onOpenChange(false)
    } finally {
      setIsBusy(false)
    }
  }

  const gameTitle = getGameTitle(detail)

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent fitContent className="min-w-full sm:min-w-2xl">
        <DialogHeader>
          <DialogTitle>{t('detailTitle')}</DialogTitle>
          <DialogDescription>{t('detailDescription')}</DialogDescription>
        </DialogHeader>

        {loading || !detail ? (
          <div className="space-y-3">
            <Skeleton className="h-6 w-52" />
            <Skeleton className="h-6 w-80" />
            <Skeleton className="h-24 w-full" />
          </div>
        ) : (
          <div className="space-y-4">
            <div className="flex flex-wrap items-center gap-2">
              <Badge variant={statusVariant}>{t(`statuses.${detail.status}`)}</Badge>
              {detail.decision_source ? (
                <Badge variant="neutral">{t(`decisionSources.${detail.decision_source}`)}</Badge>
              ) : null}
              {detail.file?.is_virus_false_positive ? (
                <Badge variant="info">{t('falsePositiveBadge')}</Badge>
              ) : null}
            </div>

            <div className="grid gap-2 text-sm text-muted-foreground">
              <div>
                {t('caseId')}: {detail.id}
              </div>
              <div>
                {t('fileName')}: {detail.file_name}
              </div>
              <div>
                {t('fileSize')}: {formatBytes(detail.file_size)}
              </div>
              <div>
                {t('resourceId')}: {detail.resource?.id ?? '-'} Â· {t('gameId')}:{' '}
                {detail.resource?.game_id ?? '-'}
              </div>
              {gameTitle ? (
                <div>
                  {t('game')}: {gameTitle}
                </div>
              ) : null}
              <div>
                {t('uploader')}: {detail.uploader.name} ({detail.uploader.id})
              </div>
              <div>
                {t('reviewer')}:{' '}
                {detail.reviewer ? `${detail.reviewer.name} (${detail.reviewer.id})` : '-'}
              </div>
              <div>
                {t('created')}: {formatDate(detail.created, locale)}
              </div>
              <div>
                {t('updated')}: {formatDate(detail.updated, locale)}
              </div>
              <div>
                {t('reviewDeadline')}: {formatDate(detail.review_deadline, locale)}
              </div>
              <div>
                {t('reviewedAt')}: {formatDate(detail.reviewed_at, locale)}
              </div>
            </div>

            <div className="rounded-lg border p-3 text-sm">
              <div className="font-medium">{t('detectedViruses')}</div>
              <div className="mt-2 text-muted-foreground whitespace-pre-wrap break-all">
                {detail.detected_viruses.length > 0
                  ? detail.detected_viruses.join(', ')
                  : t('noDetectedViruses')}
              </div>
            </div>

            {detail.scan_log_excerpt ? (
              <div className="rounded-lg border p-3 text-sm">
                <div className="font-medium">{t('scanLogExcerpt')}</div>
                <pre className="mt-2 text-xs text-muted-foreground whitespace-pre-wrap break-all">
                  {detail.scan_log_excerpt}
                </pre>
              </div>
            ) : null}

            {detail.review_note ? (
              <div className="rounded-lg border p-3 text-sm">
                <div className="font-medium">{t('reviewNote')}</div>
                <div className="mt-2 text-muted-foreground whitespace-pre-wrap">
                  {detail.review_note}
                </div>
              </div>
            ) : null}

            {detail.status === 'PENDING' ? (
              <>
                <Separator />
                <div className="space-y-3">
                  <div className="font-medium">{t('reviewTitle')}</div>
                  <div className="space-y-2">
                    <Label>{t('decision')}</Label>
                    <Select
                      value={decision}
                      onValueChange={value => setDecision(value as AdminMalwareScanDecision)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="ALLOW">{t('decisionAllow')}</SelectItem>
                        <SelectItem value="DELETE">{t('decisionDelete')}</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label>{t('reviewNote')}</Label>
                    <Textarea
                      value={reviewNote}
                      onChange={e => setReviewNote(e.target.value)}
                      placeholder={t('reviewNotePlaceholder')}
                      rows={4}
                      maxLength={500}
                    />
                  </div>

                  <div className="flex items-center gap-2">
                    <Checkbox
                      checked={notifyUploader}
                      onCheckedChange={checked => setNotifyUploader(Boolean(checked))}
                    />
                    <span className="text-sm">{t('notifyUploader')}</span>
                  </div>
                </div>
                <DialogFooter>
                  <Button
                    intent={decision === 'ALLOW' ? 'primary' : 'destructive'}
                    onClick={handleReview}
                    loading={isBusy}
                  >
                    {t('submitReview')}
                  </Button>
                </DialogFooter>
              </>
            ) : null}
          </div>
        )}
      </DialogContent>
    </Dialog>
  )
}
