'use client'

import { useMemo, useState } from 'react'
import { useLocale, useTranslations } from 'next-intl'
import { Avatar } from '@/components/common/user/Avatar'
import { Badge } from '@/components/shionui/Badge'
import { Button } from '@/components/shionui/Button'
import { cn } from '@/utils/cn'
import { AdminMalwareScanCaseItem } from '@/interfaces/admin/malware-scan.interface'
import { formatBytes } from '@/utils/format'
import { MalwareScanCaseDetailDialog } from './MalwareScanCaseDetailDialog'

interface MalwareScanCaseListItemProps {
  scanCase: AdminMalwareScanCaseItem
  onRefresh?: () => void
}

const formatDate = (value: string | null | undefined, locale: string) => {
  if (!value) return '-'
  const date = new Date(value)
  if (Number.isNaN(date.getTime())) return '-'
  return date.toLocaleString(locale, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  })
}

const getGameTitle = (scanCase: AdminMalwareScanCaseItem) => {
  if (!scanCase.resource?.game) return null
  return (
    scanCase.resource.game.title_zh ||
    scanCase.resource.game.title_en ||
    scanCase.resource.game.title_jp ||
    null
  )
}

export function MalwareScanCaseListItem({ scanCase, onRefresh }: MalwareScanCaseListItemProps) {
  const t = useTranslations('Admin.MalwareScans')
  const locale = useLocale()
  const [detailOpen, setDetailOpen] = useState(false)

  const statusVariant = useMemo(() => {
    if (scanCase.status === 'PENDING') return 'warning' as const
    if (scanCase.status === 'RELEASED_FALSE_POSITIVE') return 'info' as const
    return 'destructive' as const
  }, [scanCase.status])

  const gameTitle = getGameTitle(scanCase)

  return (
    <div
      className={cn(
        'rounded-lg border p-4 transition-colors',
        'bg-white/50 dark:bg-gray-900/50',
        'border-gray-200 dark:border-gray-800',
        'hover:bg-gray-50 dark:hover:bg-gray-800/50',
      )}
    >
      <div className="flex items-start justify-between gap-4">
        <div className="min-w-0 space-y-2">
          <div className="flex flex-wrap items-center gap-2">
            <span className="font-medium text-gray-900 dark:text-gray-100">
              {t('caseId')}: {scanCase.id}
            </span>
            <Badge variant={statusVariant}>{t(`statuses.${scanCase.status}`)}</Badge>
            {scanCase.decision_source ? (
              <Badge variant="neutral">{t(`decisionSources.${scanCase.decision_source}`)}</Badge>
            ) : null}
          </div>

          <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
            <Avatar
              clickable={false}
              user={{
                id: scanCase.uploader.id,
                name: scanCase.uploader.name,
                avatar: scanCase.uploader.avatar ?? '',
              }}
              className="size-7"
            />
            <span>
              {t('uploader')}: {scanCase.uploader.name} ({scanCase.uploader.id})
            </span>
          </div>

          <div className="text-xs text-gray-500 dark:text-gray-400">
            {t('fileId')}: {scanCase.file?.id ?? '-'} · {t('resourceId')}:{' '}
            {scanCase.resource?.id ?? '-'} · {t('gameId')}: {scanCase.resource?.game_id ?? '-'}
            {gameTitle ? ` · ${t('game')}: ${gameTitle}` : ''}
          </div>

          <div className="text-sm text-gray-600 dark:text-gray-300 break-all">
            {scanCase.file_name} ({formatBytes(scanCase.file_size)})
          </div>

          <div className="text-xs text-gray-500 dark:text-gray-400 break-all">
            {scanCase.detected_viruses.length > 0
              ? scanCase.detected_viruses.join(', ')
              : t('noDetectedViruses')}
          </div>

          <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 dark:text-gray-400">
            <span>
              {t('created')}: {formatDate(scanCase.created, locale)}
            </span>
            <span>
              {t('updated')}: {formatDate(scanCase.updated, locale)}
            </span>
            <span>
              {t('reviewDeadline')}: {formatDate(scanCase.review_deadline, locale)}
            </span>
            <span>
              {t('reviewedAt')}: {formatDate(scanCase.reviewed_at, locale)}
            </span>
          </div>
        </div>

        <Button intent="neutral" appearance="ghost" onClick={() => setDetailOpen(true)}>
          {t('viewDetail')}
        </Button>
      </div>

      <MalwareScanCaseDetailDialog
        caseId={detailOpen ? scanCase.id : null}
        open={detailOpen}
        onOpenChange={setDetailOpen}
        onReviewed={onRefresh}
      />
    </div>
  )
}
